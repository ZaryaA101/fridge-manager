{% extends 'userMain.html' %} {% block loggedInContent %}


<style>
  .Shelf {
    padding: 5px;
    margin-top: 10px;
    margin-bottom: 10px;
    font-size: 25px;
  }
</style>
  
<style>
  .Item {
    width: 70px;
    margin: 5px;
    text-align: center;
    display: inline-block;
    font-weight: 200;
  }
</style>

<style>
  /*pop up css*/
  .item-details {
      position: fixed; 
      top: 20px; 
      right: 20px; 
      width: 300px; 
      background-color: #fff; 
      border: 1px solid #ccc; 
      border-radius: 8px; 
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); 
      padding: 20px; 
      z-index: 1000; 
      display: none; /* starts hidden */
  }

  .item-details.visible {
      display: block; /* Show the popup when visible */
  }

  .close-btn {
      position: absolute; 
      top: 10px; 
      right: 10px; 
      background: none; 
      border: none; 
      font-size: 18px; 
      cursor: pointer; 
  }

  .hidden {
      display: none; /* hide elements */
  }
</style>

<style>
  .edit-btn {
      /*edit button css*/
      position: absolute;
      bottom: 10px;
      right: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
  }

  .edit-btn:hover {
      background-color: #0056b3;
  }

  .save-btn, .cancel-btn {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
  }

  .save-btn {
      background-color: #28a745;
      color: white;
      border: none;
  }

  .save-btn:hover {
      background-color: #218838;
  }

  .cancel-btn {
      background-color: #dc3545;
      color: white;
      border: none;
  }

  .cancel-btn:hover {
      background-color: #c82333;
  }
</style>

<script>
  function showItemDetails(imageElement) {
    // Get the item's details from the data attributes
    const itemId = imageElement.getAttribute('data-id');
    const itemName = imageElement.getAttribute('data-name');
    const itemDescription = imageElement.getAttribute('data-description');
    const itemExpiration = imageElement.getAttribute('data-expiration'); 
    const itemLocation = imageElement.getAttribute('data-location');
    
    // Sets the location in the details block
    document.getElementById('item-location').textContent = `Location: ${itemLocation}`;
    
    // fills the details block
    document.getElementById('item-name').textContent = `Name: ${itemName}`;
    document.getElementById('item-description').textContent = `Description: ${itemDescription}`;
    document.getElementById('item-expiration').textContent = `Expiration Date: ${itemExpiration}`; // Use the raw string

    // Stores the current item details in the edit form
    document.getElementById('edit-item-name').value = itemName;
    document.getElementById('edit-item-description').value = itemDescription;
    document.getElementById('edit-item-expiration').value = itemExpiration; // Pre-fill the expiration date

    // Stores the itemId for later use in the form submission
    document.getElementById('edit-item-form').setAttribute('data-id', itemId);

    // Shows the item details popup block
    const detailsPopup = document.getElementById('item-details');
    detailsPopup.classList.add('visible');
    document.getElementById('details-view').classList.remove('hidden');
    document.getElementById('edit-view').classList.add('hidden');
}

  function hideItemDetails() {
      // Hides the item details popup block
      const detailsPopup = document.getElementById('item-details');
      detailsPopup.classList.remove('visible');
  }

  function showEditForm() {
      // Switch to the edit form view
      document.getElementById('details-view').classList.add('hidden');
      document.getElementById('edit-view').classList.remove('hidden');
  }

  function cancelEdit() {
      // Switch back to the details view
      document.getElementById('details-view').classList.remove('hidden');
      document.getElementById('edit-view').classList.add('hidden');
  }

  function submitEditForm(event) {
    event.preventDefault();

    // Get the itemId from the form's data id attribute
    const form = document.getElementById('edit-item-form');
    const itemId = form.getAttribute('data-id');
    
    // Get the updated values from the form
    const updatedName = document.getElementById('edit-item-name').value;
    const updatedDescription = document.getElementById('edit-item-description').value;
    const updatedExpiration = document.getElementById('edit-item-expiration').value;

    // Send the updated data to the backend
      fetch(`/addItem/update-item/${itemId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            item_name: updatedName,
            item_description: updatedDescription,
            item_expiration: updatedExpiration,
        }),
    })
        .then((response) => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then((data) => {
            if (data.success) {
                // Update the UI with the new values
                const itemElement = document.querySelector(`img[data-id="${itemId}"]`);
                if (itemElement) {
                    // Update the data attributes
                    itemElement.setAttribute('data-name', updatedName);
                    itemElement.setAttribute('data-description', updatedDescription);
                    itemElement.setAttribute('data-expiration', updatedExpiration);

                    // Update the displayed name
                    const nameElement = itemElement.closest('.Item').querySelector('div');
                    if (nameElement) {
                        nameElement.textContent = updatedName;
                    }
                }

                // Update the details view
                document.getElementById('item-name').textContent = `Name: ${updatedName}`;
                document.getElementById('item-description').textContent = `Description: ${updatedDescription}`;
                document.getElementById('item-expiration').textContent = `Expiration Date: ${new Date(updatedExpiration).toLocaleDateString()}`;

                // Hide the popup
                hideItemDetails();
            } else {
                alert(`Failed to update item: ${data.error}`);
            }
        })
        .catch((error) => console.error('Error:', error));
}
</script>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    let itemIdToRemove = null; // Store the fridge item ID to remove

    function removeItem() {
      const form = document.getElementById('edit-item-form');
      itemIdToRemove = form.getAttribute('data-id'); // Store the fridge item ID for later use

      // Bootstrap stuff
      const removeItemModal = new bootstrap.Modal(document.getElementById('removeItemModal'));
      removeItemModal.show();
    }

    document.getElementById('confirmRemoveItem').addEventListener('click', function () {
      if (itemIdToRemove) {
        fetch(`/remove-fridge-item/${itemIdToRemove}/`, { // Updated the endpoint
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
          }
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Remove the item from the DOM
              const itemElement = document.querySelector(`img[data-id="${itemIdToRemove}"]`).closest('.Item');
              if (itemElement) {
                itemElement.remove();
              }

              // closes all popups
              const detailsPopup = document.getElementById('item-details');
              detailsPopup.classList.remove('visible'); // hides item details popup
              const removeItemModal = bootstrap.Modal.getInstance(document.getElementById('removeItemModal'));
              removeItemModal.hide(); // hide confirmation modal

              // it works
              const successToast = new bootstrap.Toast(document.getElementById('successToast'));
              successToast.show();

              // reset the item ID
              itemIdToRemove = null;
            } else {
              alert("Failed to remove item: " + data.error);
            }
          })
          .catch(error => {
            console.error("Error removing item:", error);
            alert("An error occurred while removing the item.");
          });
      }
    });

    window.removeItem = removeItem;
  });





  //Still working on it
  function removeItem(itemId, location, familyId) {
    console.log('Remove item called with:', itemId, location, familyId);

    if (!itemId || !location || !familyId) {
        console.error('Missing parameters for item removal:', { itemId, location, familyId });
        alert('Failed to remove item: Missing required parameters.');
        return;
    }

    itemIdToRemove = { itemId, location, familyId };
    // Show the confirmation modal
    const removeItemModal = new bootstrap.Modal(document.getElementById('removeItemModal'));
    removeItemModal.show();
}

document.addEventListener('DOMContentLoaded', function () {
  document.getElementById('confirmRemoveItem').addEventListener('click', function () {
    if (itemIdToRemove) {
      const { itemId, location, familyId } = itemIdToRemove;

      console.log('Sending DELETE request to:', `/remove-fridge-item/${encodeURIComponent(itemId)}/?location=${encodeURIComponent(location)}&family_id=${encodeURIComponent(familyId)}`);
      




      console.log('Editing item with ID:', itemId);
      console.log('Editing item with Location:', location);
      console.log('Editing item with famID:', familyId);
      //here is where it all goes wrong
      fetch(`/addItem/remove-item/${encodeURIComponent(itemId)}/?location=${encodeURIComponent(location)}&family_id=${encodeURIComponent(familyId)}`, {
    method: 'DELETE',
    headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
      },
      })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Remove the item from the DOM
            const itemElement = document.querySelector(`img[data-id="${itemId}"][data-location="${location}"]`).closest('.Item');
            console.log('Item removed successfully:', data.message);
            if (itemElement) {
              itemElement.remove();
            }

            // Closes the confirmation modal
            const removeItemModal = bootstrap.Modal.getInstance(document.getElementById('removeItemModal'));
            removeItemModal.hide();

            // Shows success 
            const successToast = new bootstrap.Toast(document.getElementById('successToast'));
            successToast.show();

            // Reset the item ID
            itemIdToRemove = null;

            // Check if the fridge is empty and update the UI
            const remainingItems = document.querySelectorAll('.Item');
            if (remainingItems.length === 0) {
              document.querySelector('.container').innerHTML = '<p class="fs-5">There are no items in the fridge.</p>';
            }
          } else {
            alert("Failed to remove item: " + data.error);
          }
        })
        .catch(error => {
          console.error("Error removing item:", error);
          alert("An error occurred while removing the item.");
        });
    }
  });
});

  
</script>



<div class="pd-4">
  <div class="fs-2">{{ family.family_name }} Fridge for {{request.user}}.</div>

  {% for item in expiring_items %}
  <div class="alert alert-warning">
     The item <strong>{{ item.item_id.item_name }}</strong> is expiring on {{ item.expiration_date }}.
  </div>
{% endfor %}
<div class="progress">
  <div class="progress-bar bg-info" role="progressbar" style="width: {{ usage_percent }}%;" aria-valuenow="{{ usage_percent }}" aria-valuemin="0" aria-valuemax="100">
    {{ usage_percent|floatformat:0 }}% Full
  </div>
</div>

{% if usage_percent > 90 %}
  <div class="alert alert-danger" role="alert">
      Warning: Your fridge is almost full ({{ usage_percent|floatformat:0 }}% used)!
  </div>
{% elif usage_percent > 75 %}
  <div class="alert alert-warning" role="alert">
    Heads up: Your fridge is getting full ({{ usage_percent|floatformat:0 }}% used).
  </div>
{% endif %}

<button type="button" 
  class="btn btn-primary"
  onclick="window.location.href='{% url 'add_item' family.family_id %}'" 
  >Add Item</button>

  {% if item_list %}
    <div class="container">

      {% for compartment in compartments %}
        <div class="Shelf">
          <h3>{{compartment}} {{ compartment.usage_ratio|floatformat:0 }}%</h3>
 
        </div>

        <div class="row">
          {% for item in item_list %}
            {% if item.compartment_id.compartment_name == compartment.compartment_name %}
            <div class="col-6 col-md-4 col-lg-3 text-center mb-3">
              <span class="Item">
                {% if item.item_id.item_image %}
                <img 
                  src="{{ item.item_id.item_image.url }}" 
                  class="img-fluid item-image" 
                  data-id="{{ item.item_id.item_id }}"
                  data-name="{{ item.item_id.item_name }}" 
                  data-description="{{ item.item_id.item_description }}"
                  data-expiration="{{ item.expiration_date|date:'Y-m-d' }}"
                  data-location="{{ item.compartment_id.compartment_name }}"
                  onclick="showItemDetails(this)"
                >
                {% else %}
                  <img 
                  src="{{ item.item_id.item_image.url }}" 
                  class="img-fluid item-image" 
                  data-id="{{ item.item_id.item_id }}"
                  data-name="{{ item.item_id.item_name }}" 
                  data-description="{{ item.item_id.item_description }}"
                  data-expiration="{{ item.expiration_date|date:'Y-m-d' }}"
                  data-location="{{ item.compartment_id.compartment_name }}"
                  onclick="showItemDetails(this)"
                  >
                {% endif %}
                <div>{{ item.item_id.item_name }}</div>
              </span>
            </div>
          {% endif %}
        {% endfor %}
      </div>
      {% endfor %}

        <!-- Item Details Popup -->
        <div id="item-details" class="item-details hidden">
        <button class="close-btn" onclick="hideItemDetails()">X</button>
        <h3>Item Details</h3>
        <div id="details-view">
          <p id="item-name"></p>
          <p id="item-description"></p>
          <p id="item-expiration"></p>
          <p id="item-location" hidden></p>
          <button class="edit-btn" onclick="showEditForm()">Edit</button>
                    <button class="remove-btn btn btn-secondary" 
                  onclick="removeItem(
                      document.getElementById('edit-item-form').getAttribute('data-id'), 
                      document.getElementById('item-location').textContent.split(': ')[1], 
                      '{{ family.family_id }}'
                  )">
              Remove
          </button>
        </div>
        
        <div id="edit-view" class="hidden">
          <form id="edit-item-form" onsubmit="submitEditForm(event)">
            {% csrf_token %}
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            
            <label for="edit-item-name">Name:</label>
            <input type="text" id="edit-item-name" name="item_name" required>
            
            <label for="edit-item-description">Description:</label>
            <textarea id="edit-item-description" name="item_description" required></textarea>
            
            <label for="edit-item-expiration">Expiration Date:</label>
            <input type="date" id="edit-item-expiration" name="item_expiration" required>
            
            <button type="submit" class="save-btn">Save</button>
            <button type="button" class="cancel-btn" onclick="cancelEdit()">Cancel</button>
          </form>
        </div>
      </div>

      <!-- Remove Item Confirmation -->
      <div class="modal fade" id="removeItemModal" tabindex="-1" aria-labelledby="removeItemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="removeItemModalLabel">Confirm Item Removal</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              Are you sure you want to remove this item?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-danger" id="confirmRemoveItem">Remove</button>
            </div>
          </div>
        </div>
      </div>


      <!-- It worked -->
      <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">
              Item removed successfully!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      </div>
      
      {% else %}
      <p class="fs-5">There are no items in the fridge.</p>
      {% endif %}
    </div>
  </div>
  
  {% endblock loggedInContent %}
  
