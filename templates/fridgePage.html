{% extends 'userMain.html' %} {% block loggedInContent %}


<style>
  .Shelf {
    padding: 5px;
    margin-top: 10px;
    margin-bottom: 10px;
    font-size: 25px;
  }
</style>
  
<style>
  .Item {
    width: 70px;
    margin: 5px;
    text-align: center;
    display: inline-block;
    font-weight: 200;
  }
</style>

<style>
  /*pop up css*/
  .item-details {
      position: fixed; 
      top: 20px; 
      right: 20px; 
      width: 300px; 
      background-color: #fff; 
      border: 1px solid #ccc; 
      border-radius: 8px; 
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); 
      padding: 20px; 
      z-index: 1000; 
      display: none; /* starts hidden */
  }

  .item-details.visible {
      display: block; /* Show the popup when visible */
  }

  .close-btn {
      position: absolute; 
      top: 10px; 
      right: 10px; 
      background: none; 
      border: none; 
      font-size: 18px; 
      cursor: pointer; 
  }

  .hidden {
      display: none; /* hide elements */
  }
</style>

<style>
  .edit-btn {
      /*edit button css*/
      position: absolute;
      bottom: 10px;
      right: 10px;
      background-color: #007bff;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
  }

  .edit-btn:hover {
      background-color: #0056b3;
  }

  .save-btn, .cancel-btn {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
  }

  .save-btn {
      background-color: #28a745;
      color: white;
      border: none;
  }

  .save-btn:hover {
      background-color: #218838;
  }

  .cancel-btn {
      background-color: #dc3545;
      color: white;
      border: none;
  }

  .cancel-btn:hover {
      background-color: #c82333;
  }
</style>

<script>
function showItemDetails(imageElement) {
    const itemId = imageElement.getAttribute('data-id');
    const itemName = imageElement.getAttribute('data-name');
    const itemDescription = imageElement.getAttribute('data-description');
    const itemExpiration = imageElement.getAttribute('data-expiration');
    const compartmentId = imageElement.getAttribute('data-location');
    const familyId = '{{ family.family_id }}'; 

    // Set the compartmentId in the form for later use
    const form = document.getElementById('edit-item-form');
    form.setAttribute('data-id', itemId);
    form.setAttribute('data-compartment-id', compartmentId);

    console.log('showdetails Item ID:', itemId);
    console.log('showdetails Compartment ID:', compartmentId);
    console.log('showdetails Family ID:', familyId);
    // Update the "Remove" button's onclick handler
    const removeButton = document.querySelector('.remove-btn');
    removeButton.setAttribute(
        'onclick',
        `removeItem('${itemId}', '${compartmentId}', '${familyId}')`
    );

    // Populate the details popup with the latest data
    document.getElementById('item-name').textContent = `Name: ${itemName}`;
    document.getElementById('item-description').textContent = `Description: ${itemDescription}`;
    document.getElementById('item-expiration').textContent = `Expiration Date: ${itemExpiration}`;

    // Populate the edit form with the latest data
    document.getElementById('edit-item-name').value = itemName;
    document.getElementById('edit-item-description').value = itemDescription;
    document.getElementById('edit-item-expiration').value = itemExpiration;

    // Show the item details popup
    const detailsPopup = document.getElementById('item-details');
    detailsPopup.classList.add('visible');
    document.getElementById('details-view').classList.remove('hidden');
    document.getElementById('edit-view').classList.add('hidden');
}

  function hideItemDetails() {
      // Hides the item details popup block
      const detailsPopup = document.getElementById('item-details');
      detailsPopup.classList.remove('visible');
  }

  function showEditForm() {
      // Switch to the edit form view
      document.getElementById('details-view').classList.add('hidden');
      document.getElementById('edit-view').classList.remove('hidden');
  }

  function cancelEdit() {
      // Switch back to the details view
      document.getElementById('details-view').classList.remove('hidden');
      document.getElementById('edit-view').classList.add('hidden');
  }

  function submitEditForm(event) {
    event.preventDefault();

    const form = document.getElementById('edit-item-form');
    const itemId = form.getAttribute('data-id');
    const compartmentId = form.getAttribute('data-compartment-id'); // Retrieve the compartmentId

    const updatedName = document.getElementById('edit-item-name').value;
    const updatedDescription = document.getElementById('edit-item-description').value;
    const updatedExpiration = document.getElementById('edit-item-expiration').value;
    const familyId = '{{ family.family_id }}';

    fetch(`/addItem/update-item/${itemId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        },
        body: JSON.stringify({
            item_name: updatedName,
            item_description: updatedDescription,
            item_expiration: updatedExpiration,
            family_id: familyId,
            compartment_id: compartmentId, // Include compartmentId in the request
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Update the UI with the new values
            const itemElement = document.querySelector(`img[data-id="${itemId}"][data-location="${compartmentId}"]`);
            if (itemElement) {
                // Update the data attributes
                itemElement.setAttribute('data-name', updatedName);
                itemElement.setAttribute('data-description', updatedDescription);
                itemElement.setAttribute('data-expiration', updatedExpiration);
            }

            // Update the details view if it's currently open
            document.getElementById('item-name').textContent = `Name: ${updatedName}`;
            document.getElementById('item-description').textContent = `Description: ${updatedDescription}`;
            document.getElementById('item-expiration').textContent = `Expiration Date: ${new Date(updatedExpiration).toLocaleDateString()}`;

            hideItemDetails(); // Close the popup
        } else {
            alert(`Failed to update item: ${data.error}`);
        }
    })
    .catch(error => console.error('Error:', error));
}



// item removal function
document.addEventListener('DOMContentLoaded', function () {
    let itemIdToRemove = null; 
    let compartmentIdToRemove = null; 
    let familyIdToRemove = null; 

    // Function to trigger the confirmation modal
    function removeItem(itemId, compartmentId, familyId) {
        if (!itemId || !compartmentId || !familyId) {
            console.error('Missing parameters for item removal:', { itemId, compartmentId, familyId });
            alert('Failed to remove item: Missing required parameters.');
            return;
        }
        console.log('Removing item with:', { itemId, compartmentId, familyId });
        // Store the IDs for later use
        itemIdToRemove = itemId;
        compartmentIdToRemove = compartmentId;
        familyIdToRemove = familyId;
        console.log('Removing item with about:', { itemIdToRemove, compartmentIdToRemove, familyIdToRemove });
        // Show the confirmation
        const removeItemModal = new bootstrap.Modal(document.getElementById('removeItemModal'));
        removeItemModal.show();
    }
    
    // Event listener for the confirmation button
    document.getElementById('confirmRemoveItem').addEventListener('click', function () {
        
        if (itemIdToRemove && compartmentIdToRemove && familyIdToRemove) {
            
            fetch(`/addItem/remove-item/${encodeURIComponent(itemIdToRemove)}/?compartment_id=${encodeURIComponent(compartmentIdToRemove)}&family_id=${encodeURIComponent(familyIdToRemove)}`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the item from the DOM
                    const itemElement = document.querySelector(`img[data-id="${itemIdToRemove}"][data-location="${compartmentIdToRemove}"]`);
                    if (itemElement) {
                        itemElement.closest('.Item').remove();
                    }

                    // Close the item details popup and confirmation modal
                    hideItemDetails();
                    const removeItemModal = bootstrap.Modal.getInstance(document.getElementById('removeItemModal'));
                    removeItemModal.hide();

                    // Show the success 
                    const successToast = new bootstrap.Toast(document.getElementById('successToast'));
                    successToast.show();

                    // Reset the stored IDs
                    itemIdToRemove = null;
                    compartmentIdToRemove = null;
                    familyIdToRemove = null;

                    // Check if the fridge is empty and update the UI
                    const remainingItems = document.querySelectorAll('.Item');
                    if (remainingItems.length === 0) {
                        document.querySelector('.container').innerHTML = '<p class="fs-5">There are no items in the fridge.</p>';
                    }
                } else {
                    alert("Failed to remove item: " + data.error);
                }
            })
            .catch(error => {
                console.error("Error removing item:", error);
                alert("An error occurred while removing the item.");
            });
        }
    });

    window.removeItem = removeItem;
});

</script>




<div class="pd-4">
  <div class="fs-2">{{ family.family_name }} Fridge for {{request.user}}.</div>

  {% for item in expiring_items %}
  <div class="alert alert-warning">
     The item <strong>{{ item.item_id.item_name }}</strong> is expiring on {{ item.expiration_date }}.
  </div>
{% endfor %}
<div class="progress">
  <div class="progress-bar bg-info" role="progressbar" style="width: {{ usage_percent }}%;" aria-valuenow="{{ usage_percent }}" aria-valuemin="0" aria-valuemax="100">
    {{ usage_percent|floatformat:0 }}% Full
  </div>
</div>

{% if usage_percent > 90 %}
  <div class="alert alert-danger" role="alert">
      Warning: Your fridge is almost full ({{ usage_percent|floatformat:0 }}% used)!
  </div>
{% elif usage_percent > 75 %}
  <div class="alert alert-warning" role="alert">
    Heads up: Your fridge is getting full ({{ usage_percent|floatformat:0 }}% used).
  </div>
{% endif %}

<div style="font-size: 17px;">You are currently using {{ user_percent|floatformat:0 }}% of your {{ limit_fraction|floatformat:0 }}%</div>
<button type="button" 
  style="margin-top:5px"
  class="btn btn-primary"
  onclick="window.location.href='{% url 'add_item' family.family_id %}'" 
  >Add Item</button>

  {% if item_list %}
    <div class="container">

      {% for compartment in compartments %}
        <div class="Shelf">
          <h3>{{compartment}} {{ compartment.usage_ratio|floatformat:0 }}%</h3>
 
        </div>

        <div class="row">
          {% for item in item_list %}
            {% if item.compartment_id.compartment_name == compartment.compartment_name %}
            <div class="col-6 col-md-4 col-lg-3 text-center mb-3">
              <span class="Item">
                {% if item.item_id.item_image %}
                <img 
                  src="{{ item.item_id.item_image.url }}" 
                  class="img-fluid item-image" 
                  data-id="{{ item.item_id.item_id }}"
                  data-name="{{ item.item_id.item_name }}" 
                  data-description="{{ item.item_id.item_description }}"
                  data-expiration="{{ item.expiration_date|date:'Y-m-d' }}"
                  data-location="{{ item.compartment_id.compartment_id }}"
                  onclick="showItemDetails(this)"
                >
                {% else %}
                  <img 
                  src="{{ item.item_id.item_image.url }}" 
                  class="img-fluid item-image" 
                  data-id="{{ item.item_id.item_id }}"
                  data-name="{{ item.item_id.item_name }}" 
                  data-description="{{ item.item_id.item_description }}"
                  data-expiration="{{ item.expiration_date|date:'Y-m-d' }}"
                  data-location="{{ item.compartment_id.compartment_id }}"
                  onclick="showItemDetails(this)"
                  >
                {% endif %}
                <div>{{ item.item_id.item_name }}</div>
              </span>
            </div>
          {% endif %}
        {% endfor %}
      </div>
      {% endfor %}

        <!-- Item Details Popup -->
        <div id="item-details" class="item-details hidden">
        <button class="close-btn" onclick="hideItemDetails()">X</button>
        <h3>Item Details</h3>
        <div id="details-view">
          <p id="item-name"></p>
          <p id="item-description"></p>
          <p id="item-expiration"></p>
          <p id="item-location" ></p>
          
          <button class="edit-btn" onclick="showEditForm()">Edit</button>
          <button class="remove-btn btn btn-secondary" onclick="removeItem()">Remove</button>
        </div>
        
        <div id="edit-view" class="hidden">
          <form id="edit-item-form" onsubmit="submitEditForm(event)">
            {% csrf_token %}
            <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
            
            <label for="edit-item-name">Name:</label>
            <input type="text" id="edit-item-name" name="item_name" required>
            
            <label for="edit-item-description">Description:</label>
            <textarea id="edit-item-description" name="item_description" required></textarea>
            
            <label for="edit-item-expiration">Expiration Date:</label>
            <input type="date" id="edit-item-expiration" name="item_expiration" required>
            
            <button type="submit" class="save-btn">Save</button>
            <button type="button" class="cancel-btn" onclick="cancelEdit()">Cancel</button>
          </form>
        </div>
      </div>

      <!-- Remove Item Confirmation -->
      <div class="modal fade" id="removeItemModal" tabindex="-1" aria-labelledby="removeItemModalLabel" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="removeItemModalLabel">Confirm Item Removal</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              Are you sure you want to remove this item?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-danger" id="confirmRemoveItem">Remove</button>
            </div>
          </div>
        </div>
      </div>


      <!-- It worked -->
      <div class="toast-container position-fixed bottom-0 end-0 p-3">
        <div id="successToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body">
              Item removed successfully!
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      </div>
      
      {% else %}
      <p class="fs-5">There are no items in the fridge.</p>
      {% endif %}
    </div>
  </div>
  
  {% endblock loggedInContent %}
  
